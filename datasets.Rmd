---
title: "datasets"
author: "John Morse"
date: "2/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, include = FALSE}
library(readxl)
library(janitor)
library(tidyverse)
library(gt)
library(rvest)
library(reprex)
library(fivethirtyeight)
library(stringr)
library(usmap)
library(shinythemes)
library(ggcorrplot)
library(htmltools)
library(vembedr)
library(wesanderson)
library(infer)
```

My work so far: My data comes from a variety of sources that includes the CDC,
academic research, and a pharmaceutical company.

I have spent most of my time cleaning the data and ensuring that all of the
disparate graphs and tables are in proper form so that I can run analysis. My
work so far has looked like this:


1. Gather data and store on my computer 

2. Create GitHub repo which can be found here:
https://github.com/jrmorse/final_project_datasets

3. Load data into my .rmd


4. scrape data from a website into my RMD. Here I had to spend a lot time
ensuring that the format was correct. This meant getting rid of the costs for
diseases that I wasnâ€™t interested in, converting characters to integers, and
segmenting between direct and indirect medical costs.


5.  I made a function to run through a folder in my repo and to automatically,
pull, clean, and combine data referring to PrEP usage in the U.S.


6. I made a quick bar graph to show the increase of usage between men and women
between 2012-2018.


7. Then I read in, cleaned, and reformatted all CDC data for HIV and other
relevant STIs.

*Please see below for the tables I have created*

```{r all costs}
# This includes the direct medical costs associated with key STIs in the U.S.. I
# will be looking at the costs of HIV, chlamydia, gonorrhea, and I think
# syphilis as well. The prices listed are in 2006 USD, so I will create another
# column that calculates the 2019 USD cost for each infection.I have used the
# pivot long function to create a new column relating to sex. The data should be
# clean and I have used the slice function to get rid of unwanted rows. 

table_costs_messy <- read_html("https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2426671/")%>% 
  html_node("table") %>% 
  html_table(header = TRUE) %>% 
  clean_names() %>% 
  slice(-1) %>% 
  slice(4:17)

# This is where I have made sex a new column so that I can better compare costs
# of illness for men and women. Additionally I have created a column to adjust
# 2006 USD to that of 2020 USD. The rate of inflation between the years was
# 131%.

costs_clean <- table_costs_messy %>% 
  rename(xF = value_applied, xM = x) %>% 
  pivot_longer(
    cols = starts_with("x"),
    names_to = "sex",
    names_prefix = "x",
    values_to = "cost",
    values_drop_na = FALSE
  ) %>% 
# I did this line below to get rid of extra text in the parameter column.
  mutate_all(~ gsub(x =., pattern = "\\*| \\[5]| \\[6]| \\[1,64,65]| \\[85]", "")) %>% 

  mutate(cost_2006 = parse_number(cost)) %>% 
  mutate(cost_2020 = (cost_2006 * 1.31)) %>% 
  select("parameter", "sex", "cost_2020")

costs_clean

# This table does not differentiate between indirect and direct costs as the
# dataset has indirect costs listed as a separate that is embedded in the data.
# In the following r blocks I will separate out the indirectand direct costs so
# that I can be more specific.
```
```{r DIRECT COSTS FOR HIV & STIS}

# This is the data that is just focused on direct medical costs.

direct_costs <-
  costs_clean %>% 
  slice(1:10)
colnames(direct_costs)[3] <- "direct_cost_2020"

direct_costs
```


```{r INDIRECT COSTS HIV & STIS}

# This is the data that is concerned with the indirect costs of HIV

indirect_costs_hiv <- costs_clean %>% 
  slice(13:14)

# This is the indirect costs of other relevant STIs

indirect_costs_sti <- costs_clean %>% 
  slice(21:28) 

# Here I'll join these two tables together with a bind function.
indirect_costs = rbind(indirect_costs_hiv, indirect_costs_sti)

# change the title of the cost column to be more specific
colnames(indirect_costs)[3] <- "indirect_cost_2020"

indirect_costs

```
```{r INDIRECT & DIRECT COSTS}
 # this is what I will use as a reference.

complete_costs <- direct_costs %>% 
  full_join(indirect_costs, direct_costs, by = c("parameter"= "parameter","sex"="sex")) %>% 
  mutate(total_cost = direct_cost_2020 + indirect_cost_2020)

complete_costs
```


{r, PREP DATA_National, include = FALSE
# Empty data set where I will store the files once they'e loaded in.
prep_data_1 <- data.frame()

# Listing out all the files in this particular folder. All of this data relates
# to PrEP usage in the U.S..
list <- list.files("Data_Sets/PrEP_Data")

# Here I have the actual function which is picking up on every document that
# ends in ".xlsx" in the "PrEP_Data" folder. The function reads in all of the
# data, and then spits each one into the empty dataframe that I have created.
# Each row is appended onto the preceding year's data.

listxlsx <- dir(pattern = "*.xlsx")
for (i in 1:length(list)){
  print(list[i])
  temp_data <- read_xlsx(paste("Data_Sets/PrEP_Data/",
                               list[i], sep = ""),
                         skip = 1) %>% 
    clean_names()
  
  prep_data_1 = rbind(prep_data_1, temp_data)
}

prep_data_1


```{r Prep data state}
prep_data_state <- data.frame()

# Listing out all the files in this particular folder. All of this data relates
# to PrEP usage in the U.S. on a state level.
list <- list.files("Data_Sets/prep_data_state")

# Here I have the actual function which is picking up on every document that
# ends in ".xlsx" in the "prep_data_state" folder. The function reads in all of the
# data, and then spits each one into the empty dataframe that I have created.
# Each row is appended onto the preceding year's data.

listxlsx <- dir(pattern = "*.xlsx")
for (i in 1:length(list)){
  print(list[i])
  temp_data <- read_xlsx(paste("Data_Sets/prep_data_state/",
                               list[i], sep = ""),
                         skip = 1) %>% 
    clean_names()
  
  prep_data_state = rbind(prep_data_state, temp_data)
}

prep_data_state

```

```{r prep racial estimation}
# this is 2016 data.
# I think I will assume these rates as constant and see how it might explain different trends by race. Is there some way I can hold other variables constant?

prep_race <- read_html("https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6193685/table/T2/?report=objectonly")%>% 
  html_node("table") %>% 
  html_table(header = TRUE, fill = TRUE) %>% 
  clean_names() %>% 
  slice(16:20)

# Changing names of the races so that they match the data set I have from the CDC. Also getting rid of unwanted characters and converting to numerics so that I can find percentage by demographic.
race <- str_replace(prep_race$characteristic, "Black", "Black/ African American")
race <- str_replace(race, "Hispanic", "Hispanic/ Latino")
drug_use_30 <- str_replace(prep_race$length_of_drug_useno_percent, " \\(.*\\)", "")
drug_use_30 <- str_replace(drug_use_30, ",", "")
drug_use_30 <- as.numeric(drug_use_30)
drug_use_28 <- str_replace(prep_race$length_of_drug_useno_percent_2, " \\(.*\\)", "")
drug_use_28 <- str_replace(drug_use_28, ",", "")
drug_use_28 <- as.numeric(drug_use_28)

# Cleaning up the data so that I can pull the demographics of prep users. I have consolidated those users who are more than 28 days and those who are more than 30 days so that I can have one generalizable percentage. 

prep_race <- prep_race %>% 
  mutate(race = race,
         x = drug_use_30,
         y = drug_use_28,
         total = x + y,
         proportion = total / sum(total)) %>% 
select(race, proportion)

prep_race
```

```{r PrEP growth rates for men and women_state}
# data for only male users
prep_m_state <- prep_data_state %>% 
  select(year, male_pr_ep_users, state_abbreviation, state) %>%
  mutate(sex = "Male")
colnames(prep_m_state)[2] <- c("pr_ep_users")
prep_m_state

# data for only female users
prep_f_state <- prep_data_state %>% 
  select(year, female_pr_ep_users, state_abbreviation, state) %>% 
  mutate(sex = "Female")
colnames(prep_f_state)[2] <- c("pr_ep_users") 
prep_f_state

# Here I'll use the bind function to list the information ontop of eachother. I did not realize this earlier, but I cannot do this if I am grouping by state. If so, the values on the y axis are all wrong.

prep_gender_state <- rbind(prep_f_state, prep_m_state) %>% 
  group_by(year, sex) %>% 
  summarize(total_cases = sum(pr_ep_users))

# this graph is based off the dataset above and should be working correctly now that I've removed state from the dataset.

ggplot(data = prep_gender_state, aes(x = year, y = total_cases, fill = sex)) +
  geom_col(position = "dodge") +
  labs(title="PrEP Users by Gender", subtitle = "2012-2018") +
  theme_classic()+
  scale_x_continuous(
  breaks = seq(2012,2018,1),
  label = c("2012", "2013", "2014", "2015", "2016","2017","2018"))

ggplot(data = prep_gender_state, aes(x = year, y = pr_ep_users, fill = sex)) +
  geom_col(position = "dodge") +
  labs(title="PrEP Users by Gender", subtitle = "2012-2018") +
  theme_classic()+
  scale_x_continuous(
  breaks = seq(2012,2018,1),
  label = c("2012", "2013", "2014", "2015", "2016","2017","2018"))

```

```{r prep_m_state with race}
# It is likely that female racial use is different than males. Females, however, make up such a small portion of users, the proportion I have generated is likely quite accurate. I will not, however, apply the racial estimations to females who use prep as these values may not be representative.

prep_m_state_race <- prep_m_state %>% 
  group_by(year) %>%
  summarise(pr_ep_users = sum(pr_ep_users))
prep_m_state_race

prep_f_state_race <- prep_f_state %>% 
  group_by(year) %>%
  summarise(pr_ep_users = sum(pr_ep_users))
prep_f_state_race

prep_f_state_race <- prep_gender_state %>% 
  filter(year== 2018 & sex == "Male") %>% 
  summarise(pr_ep_users = sum(pr_ep_users))
prep_f_state_race


# Here I am making a dataframe based off total male prep users. I assigned each user from 2018 with an ID number. From there, I applied the racial demographic estimates from the 2016 article that I cited. When I run a prop.table function, the percentages of users match up. I will use this frame to generate the liklihood of selecting a user who is of race x. Total values of races are included here: white = 1:84176, black = 14277, latino = 16571, asian = 5563, other = 2947.

prep_race_sample <- data.frame(id = 1:123534) %>% 
  mutate(race = ifelse(id %in% 1:84176, "White",
                       ifelse(id %in% 84177:98454, "Black/ African American",
                              ifelse(id %in% 98455: 115026, "Hispanic/ Latino",
                                     ifelse(id %in% 115027: 120590, "Asian", "Unspecified")))))
prep_race_sample %>% 
  rep_sample_n(size = 5, replace = TRUE, reps = 1) %>% 
  #select(race) %>% 
  ggplot(aes(x = race)) +
  geom_bar() +
  theme_classic() + 
  labs(
    title = "Racial Charecteristics of Sample",
    x = "Race",
    y = "Count"
  )
  

y %>% 
prep_race_sample %>% 
  group_by(id)
  mutate(is_white = (race== "White")) %>% 
  summarize(num_white = sum(is_white)) %>% 
  mutate(prop_white = num_white/123534)

``` 


```{r}
# CHLAMYDIA AND GONORRHEA ONLY
# Here I read in all the CDC data for Chlamydia and Gonorrhea rates from 2000 to
# 2017. I still should rename the columns so that it is clear which values are
# for which variable when I join the datasets. Also, for testing pursposes, I
# have set this to only return the first ten rows as it is a large dataset.


chlamydia_gonorrhea <-read_xlsx("Data_Sets/CDC_Data/ATLAS_CDC_Chlamydia&Gonorrhea.xlsx",
  skip = 5) %>% 
  clean_names() 
chlamydia_gonorrhea[chlamydia_gonorrhea == "Data not available"] <-NA

chlamydia_gonorrhea <- chlamydia_gonorrhea %>%
  filter(!is.na(cases))
chlamydia_gonorrhea

```

```{r HIV DIAGNOSIS ONLY}
# Here I read in all the CDC data for HIV/AIDS rates for females from 2008 to
# 2017. I have added an extra column to list what the sex is.

hiv_aids_f <- read_xlsx("Data_Sets/CDC_Data/Atlas_CDC_HIV:AIDS_Female.xlsx",
  skip = 8) %>% 
  clean_names() %>% 
  mutate(sex = "Female")
hiv_aids_f[hiv_aids_f == "Data not available"] <-NA

# Here I read in all the CDC data for HIV/AIDS rates for males from 2008 to
# 2017. I have added an extra column to list what the sex is.

hiv_aids_m <- read_xlsx("Data_Sets/CDC_Data/AtlasPlus_CDC_Male_HIV:AIDS.xlsx",
  skip = 8) %>% 
  clean_names() %>% 
  mutate(sex = "Male")
hiv_aids_m[hiv_aids_m == "Data not available"] <-NA

# Here I merged the two HIV/AIDS datasets as the variables were the same for
# both the female and male tables. For testing purposes, I am only showing the
# first 10 rows.

# I filtered for indicator of HIV diagnoses because if I do not, it lumps prevelance and diagnoses together in a way that is misleading for the information I want to communicate.

hiv_aids_all <- rbind(hiv_aids_f, hiv_aids_m) %>% 
  filter(indicator == "HIV diagnoses")

```

```{r HIV Cases by year Graph}
# A table with hiv diagnoses by year for both sexes.

hiv_aids_year <- hiv_aids_all %>% 
  group_by(year) %>%
  summarize(total_cases = sum(cases))

# A plot that I have included in shiny. All diagnoses by year.

 hiv_total <- ggplot(hiv_aids_year, aes(x = year, y = total_cases)) +
   geom_point() +
   geom_text(aes(x = year, y = total_cases, label = total_cases),vjust = -1, nudge_y = .5) +
   labs(title="HIV Diagnoses by Year", subtitle = "2007-2017") +
   theme_classic() +
   scale_x_continuous(
     name = "Year",
     breaks = seq(2007,2017,1),
     label = c("2007", "2008", "2009", "2010", "2011","2012","2013","2014","2015","2016","2017")) +
   scale_y_continuous(
     name = "New Diagnoses",
     limits=c(35000, 50000))

```

```{r HIV Diagnoses by Gender Graph}
# A graph of HIV diagnoses by gender.

ggplot(data = hiv_aids_all, aes(x = year, y = cases, fill = sex)) +
  geom_col(position = "dodge") +
  labs(title="HIV Diagnoses by Gender", subtitle = "2007-2017") +
  theme_classic() +
  scale_x_continuous(
    name = "Year",
    breaks = seq(2007,2017,1),
    label = c("2007", "2008", "2009", "2010", "2011","2012","2013","2014","2015","2016","2017")) +
  scale_y_continuous(
    name = "New Diagnoses"
  )
```

```{r HIV Diagnoses Transmission Category table}
hiv_aids_transmission <- hiv_aids_all %>% 
  group_by(transmission_category, year, sex) %>%
  summarize(total_cases = sum(cases))
hiv_aids_transmission
```

```{r HIV Diagnosis by transmission category}
ggplot(data = hiv_aids_transmission, aes(x = year, y = total_cases, fill = transmission_category)) +
  geom_col(position = "dodge") +
  labs(title="HIV Diagnosis by Category", subtitle = "2007-2017") +
  theme_classic() +
  # scale_fill_manual(values = wes_palette(name="Darjeeling2", n=5)) +
  scale_x_continuous(
    name = "Year",
    breaks = seq(2007,2017,2),
    label = c("2007", "2009", "2011","2013","2015","2017")) +
  scale_y_continuous(
    name = "New Diagnoses"
  ) +
  labs(fill = "Transmission Category")
```


```{r Male to male sexual contact}
hiv_aids_maletomalesexualcontact <- hiv_aids_all %>% 
  filter(transmission_category == "Male-to-male sexual contact" & race_ethnicity %in% c("White","Black/African American", "Hispanic/Latino", "Asian")) %>%
  group_by(year, race_ethnicity) %>%
  summarize(total_cases = sum(cases))

ggplot(data = hiv_aids_maletomalesexualcontact, aes(x = year, y = total_cases, fill = race_ethnicity)) +
  geom_col(position = "dodge") +
  facet_wrap(~ race_ethnicity) +
  labs(title="HIV Diagnosis Male-to-male Sexual Contact", subtitle = "2007-2017") +
  theme_classic() +
  scale_x_continuous(
    name = "Year",
    breaks = seq(2007,2017,1),
    label = c("2007", "2008", "2009", "2010", "2011","2012","2013","2014","2015","2016","2017")) +
  scale_y_continuous(
    name = "New Diagnoses"
  )
```


```{r}
# SYPHILIS ONLY
# Here I read in all the CDC data for both early latent and congential syphilis
# rates from 2008 to 2017. I still should rename the columns so that it is clear
# which values are for which variable when I join the datasets.

syphilis <- read_xlsx("Data_Sets/CDC_Data/Atlas_Congenital&EarlyLatentSyphilis.xlsx",
  skip = 7) %>% 
  clean_names()
syphilis[syphilis == "Data not available"] <-NA

```

